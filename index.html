<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dziennik Klasy</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background-color: #f5f5f5;
        color: #333;
    }

    .container {
        max-width: 1850px;  /* ZMIENIONE Z 1400px NA 1900px */
        margin: 0 auto;
        background-color: white;
        min-height: 100vh;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab.active {
            background-color: white;
            color: #2c3e50;
        }

        .tab:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .main-content {
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .section-title {
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .week-range {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .calendar th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 500;
        }

        .calendar td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
            height: 80px;
        }

        .time-header {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
            width: 60px;
        }

        .lesson-normal { background-color: #e3f2fd; }
        .lesson-substitution { background-color: #fff3e0; }
        .lesson-exam { background-color: #ffebee; }
        .lesson-quiz { background-color: #fce4ec; }
        .lesson-completed { background-color: #e8f5e8; }
        .lesson-absence { background-color: #f5f5f5; }
        .lesson-cancelled { background-color: #f8d7da; }
        .lesson-substitute-for { background-color: #d1ecf1; }

        .lesson-item {
            padding: 4px 6px;
            border-radius: 3px;
            margin-bottom: 2px;
            font-size: 12px;
            cursor: pointer;
            position: relative;
        }

        .lesson-item:hover {
            opacity: 0.8;
        }

        .lesson-class {
            font-weight: bold;
        }

        .lesson-topic {
            font-style: italic;
            margin-top: 2px;
            font-size: 11px;
        }

        .lesson-status {
            font-size: 10px;
            margin-top: 2px;
            font-weight: bold;
        }

        .event-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grade-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .grade-table-container {
            overflow-x: auto;
        }

        .grade-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .grade-table th {
            background-color: #34495e;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grade-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }

        .student-name {
            text-align: left;
            font-weight: 500;
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 5;
        }

        .semester-header {
            background-color: #2c3e50 !important;
        }

        .grade-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 40px;
        }

        .grade-cell:hover {
            background-color: #f8f9fa;
        }

        .average-cell {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .material-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }

        .material-list {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .material-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .material-item:last-child {
            border-bottom: none;
        }

        .material-item.completed {
            background-color: #e8f5e8;
        }

        .material-info {
            flex: 1;
        }

        .material-topic {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .material-date {
            color: #7f8c8d;
            font-size: 14px;
        }

        .material-actions {
            display: flex;
            gap: 10px;
        }

        .event-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .event-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .event-date {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .event-description {
            color: #555;
        }

        .admin-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .admin-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .admin-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .class-list, .student-list, .category-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .class-item, .student-item, .category-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .class-item:last-child, .student-item:last-child, .category-item:last-child {
            border-bottom: none;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .small-btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        .hidden {
            display: none !important;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .grade-entry-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .student-grades-entry {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }

        .student-grade-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .student-grade-row:last-child {
            border-bottom: none;
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .schedule-table th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 500;
        }

        .schedule-table td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
            height: 80px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .schedule-table td:hover {
            background-color: #f8f9fa;
        }

        .schedule-lesson {
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 12px;
            background-color: #e3f2fd;
        }

        .schedule-lesson:hover {
            opacity: 0.8;
        }
		/* ========== SEKCJA WYNIKI ========== */
.results-table-container {
    overflow-x: auto;
    margin: 20px 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.results-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
}

.results-table th {
    padding: 10px 8px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.2);
    font-weight: 600;
    font-size: 12px;
    white-space: nowrap;
}

.results-table tbody tr {
    border-bottom: 1px solid #e0e0e0;
    transition: all 0.3s ease;
}

.results-table tbody tr:hover {
    background-color: #f5f5f5;
    transform: scale(1.01);
}

.results-table td {
    padding: 8px 6px;
    text-align: center;
    border: 1px solid #e0e0e0;
}

.results-table .student-name {
    text-align: left;
    font-weight: 600;
    padding-left: 12px;
    min-width: 150px;
    background: #f8f9fa;
    position: sticky;
    left: 0;
    z-index: 5;
}

/* Kolumny ze ≈õrednimi */
.grade-avg {
    background: #f0f4f8;
    font-weight: 500;
}

.year-avg {
    background: #e8f5e9;
    font-weight: 600;
    color: #2e7d32;
}

.summary-avg {
    background: #fff3e0;
    font-weight: 600;
    color: #f57c00;
    font-size: 15px;
}

.overall-avg {
    background: #e3f2fd;
    font-weight: 700;
    color: #1565c0;
    font-size: 15px;
}

.final-avg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 16px;
}

/* Kolorowanie wierszy na podstawie ≈õredniej */
.results-table tbody tr.excellent {
    background: linear-gradient(to right, transparent, rgba(76, 175, 80, 0.1));
    border-left: 4px solid #4caf50;
}

.results-table tbody tr.good {
    background: linear-gradient(to right, transparent, rgba(139, 195, 74, 0.1));
    border-left: 4px solid #8bc34a;
}

.results-table tbody tr.average {
    background: linear-gradient(to right, transparent, rgba(255, 193, 7, 0.1));
    border-left: 4px solid #ffc107;
}

.results-table tbody tr.poor {
    background: linear-gradient(to right, transparent, rgba(255, 152, 0, 0.1));
    border-left: 4px solid #ff9800;
}

.results-table tbody tr.fail {
    background: linear-gradient(to right, transparent, rgba(244, 67, 54, 0.1));
    border-left: 4px solid #f44336;
}

/* Filtry wynik√≥w */
.results-filters {
    margin: 20px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.results-filters label {
    font-weight: 600;
    color: #333;
}

.results-filters select {
    padding: 8px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    background: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.results-filters select:hover {
    border-color: #667eea;
}

.results-filters select:focus {
    outline: none;
    border-color: #764ba2;
    box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
}

/* Podsumowanie klasy */
.results-summary {
    margin-top: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.results-summary h3 {
    margin: 0 0 15px 0;
    font-size: 20px;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    padding-bottom: 10px;
}

#class-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

#class-summary p {
    margin: 0;
    padding: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(10px);
}

#class-summary span {
    font-size: 24px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

/* Przyciski w sekcji wynik√≥w */
.section-header .section-actions {
    display: flex;
    gap: 10px;
}

#export-results {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

#export-results:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
}

#refresh-results {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

#refresh-results:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
}

/* Responsywno≈õƒá */
@media (max-width: 768px) {
    .results-table {
        font-size: 12px;
    }
    
    .results-table th,
    .results-table td {
        padding: 5px 3px;
    }
    
    .results-filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    #class-summary {
        grid-template-columns: 1fr;
    }
}

/* Animacje */
@keyframes highlightRow {
    0% { background-color: #fff3e0; }
    50% { background-color: #ffeb3b; }
    100% { background-color: #fff3e0; }
}

.results-table tbody tr:target {
    animation: highlightRow 2s ease;
}

/* Dodatkowe style dla lepszej czytelno≈õci */
.results-table tbody tr:nth-child(even) {
    background-color: rgba(0, 0, 0, 0.02);
}

.results-table td:first-child {
    font-weight: bold;
    color: #666;
    background: #f8f9fa;
}

/* Tooltip dla ≈õrednich */
.grade-avg:hover,
.summary-avg:hover,
.overall-avg:hover {
    position: relative;
    background-color: #ffeb3b;
    cursor: help;
}

/* Drukowanie */
@media print {
    .results-filters,
    .section-actions,
    .nav-tabs,
    .menu {
        display: none !important;
    }
    
    .results-table {
        page-break-inside: avoid;
    }
    
    .results-summary {
        page-break-before: always;
    }
}

        .material-topics-input {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }

        .grade-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .grade-details p {
            margin-bottom: 8px;
        }

        .lesson-details-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

            .topic-list {
        max-height: 500px;  /* ZMIENIONE Z 200px NA 500px */
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
    }

        .topic-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topic-item:last-child {
            border-bottom: none;
        }

        .topic-item.completed {
            background-color: #e8f5e8;
        }

        .topic-checkbox {
            width: 16px;
            height: 16px;
        }

        .substitution-details {
            background-color: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #f39c12;
        }

        .grade-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            color: green;
            font-weight: bold;
        }

        .quiz-indicator {
            position: absolute;
            bottom: 2px;
            right: 12px;
            color: purple;
            font-weight: bold;
        }

        .event-item {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            position: relative;
        }

        .event-item:hover {
            opacity: 0.8;
        }

        .event-item-title {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .add-event-btn-container {
            margin-bottom: 20px;
            text-align: right;
        }
        
        .menu {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #222;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .menu a {
            color: white;
            text-decoration: none;
            margin-bottom: 8px;
            font-family: Arial, sans-serif;
        }

        .menu a:hover {
            text-decoration: underline;
        }
        
        .class-info {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .subject-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .subject-selector label {
            margin-bottom: 0;
            font-weight: bold;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
            color: #3498db;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">
        <div>≈Åadowanie danych...</div>
    </div>

    <div class="menu">
        <a href="https://fillxd.github.io/sz57">Syst</a>
        <a href="https://fillxd.github.io/tm57">TM</a>
        <a href="https://fillxd.github.io/pl57">Plan</a>
        <a href="https://fillxd.github.io/na57">MG</a>
        <a href="https://fillxd.github.io/tk57">D5b</a>
        <a href="https://fillxd.github.io/kl57">T5b</a>
        <a href="https://docs.google.com/spreadsheets/d/18OV9Sar_ENFseGPn8wppwrIeJXm6j4dsa890OTg6Ioo/edit?gid=1302175797#gid=1302175797">ARK</a>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <h1>üìö Dziennik Klasy</h1>
            </div>
            <div class="nav-tabs">
    <div class="tab active" data-tab="home">Strona G≈Ç√≥wna</div>
    <div class="tab" data-tab="schedule">Plan Lekcji</div>
    <div class="tab" data-tab="material">Rozk≈Çad Materia≈Çu</div>
    <div class="tab" data-tab="grades">Oceny</div>
    <div class="tab" data-tab="results">Wyniki</div>  <!-- DODAJ Tƒò LINIƒò -->
    <div class="tab" data-tab="admin">Administracja</div>
</div>
        </header>

        <div class="main-content">
            <section id="home" class="section active">
                <div class="section-header">
                    <h2 class="section-title">Strona G≈Ç√≥wna - Terminarz Tygodniowy</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="prev-week">‚Üê Poprzedni</button>
                        <button class="btn btn-primary" id="next-week">Nastƒôpny ‚Üí</button>
                    </div>
                </div>
                
                <div class="class-info">
                    <h3>Klasa: <span id="current-class-name">5B</span></h3>
                    <p>Wychowawca: <span id="class-teacher">Mateusz Gig</span></p>
                </div>
                
                <div class="add-event-btn-container">
                    <button class="btn btn-success" id="add-event-btn">DODAJ WYDARZENIE</button>
                </div>
                
                <div class="calendar-navigation">
                    <div class="week-range" id="week-range">≈Åadowanie...</div>
                </div>
                
              
                
                <div class="calendar-container">
                    <table class="calendar" id="weekly-calendar">
                        <thead>
                            <tr>
                                <th>Godzina</th>
                                <th>Poniedzia≈Çek</th>
                                <th>Wtorek</th>
                                <th>≈öroda</th>
                                <th>Czwartek</th>
                                <th>PiƒÖtek</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body"></tbody>
                    </table>
                </div>
				  <div class="upcoming-events">
                    <h3>NadchodzƒÖce wydarzenia</h3>
                    <div id="upcoming-events-list" class="event-list"></div>
                </div>
            </section>

            <section id="schedule" class="section">
                <div class="section-header">
                    <h2 class="section-title">Plan Standardowy</h2>
                </div>
                
                <div class="class-info">
                    <h3>Klasa: <span id="schedule-class-name">5B</span></h3>
                </div>
                
                <div class="calendar-container">
                    <table class="schedule-table" id="schedule-table">
                        <thead>
                            <tr>
                                <th>Godzina</th>
                                <th>Poniedzia≈Çek</th>
                                <th>Wtorek</th>
                                <th>≈öroda</th>
                                <th>Czwartek</th>
                                <th>PiƒÖtek</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="material" class="section">
                <div class="section-header">
                    <h2 class="section-title">Rozk≈Çad Materia≈Çu</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="add-material">Dodaj Tematy</button>
                    </div>
                </div>
                
                <div class="class-info">
                    <h3>Klasa: <span id="material-class-name">5B</span></h3>
                </div>
                
                <div class="subject-selector">
                    <label for="material-subject">Przedmiot:</label>
                    <select id="material-subject">
                        <option value="">-- Wybierz przedmiot --</option>
                    </select>
                </div>
                
                <div class="material-list" id="material-list"></div>
            </section>

            <section id="grades" class="section">
                <div class="section-header">
                    <h2 class="section-title">System Oceniania</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="add-grade-bulk">Dodaj Oceny Seryjnie</button>
                        <button class="btn btn-success" id="add-grade-single">Dodaj Ocenƒô PojedynczƒÖ</button>
                    </div>
                </div>
                
                <div class="class-info">
                    <h3>Klasa: <span id="grades-class-name">5B</span></h3>
                </div>
                
                <div class="subject-selector">
                    <label for="grade-subject">Przedmiot:</label>
                    <select id="grade-subject">
                        <option value="">-- Wybierz przedmiot --</option>
                    </select>
                    <label for="grade-semester">Semestr:</label>
                    <select id="grade-semester">
                        <option value="1">Semestr I</option>
                        <option value="2">Semestr II</option>
                    </select>
                    <label for="grade-category">Kategoria:</label>
                    <select id="grade-category">
                        <option value="all">Wszystkie kategorie</option>
                    </select>
                </div>
                
                <div class="grade-table-container">
                    <table class="grade-table" id="grade-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Ucze≈Ñ</th>
                                <th colspan="20" class="semester-header">Semestr I</th>
                                <th colspan="20" class="semester-header">Semestr II</th>
                                <th rowspan="2">≈örednia</th>
                            </tr>
                            <tr>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
                                <th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>P≈öR</th><th>≈öR</th><th>S1</th>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
                                <th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>PR</th><th>R</th><th>S2</th>
                            </tr>
                        </thead>
                        <tbody id="grade-table-body"></tbody>
                    </table>
                </div>
            </section>
<section id="results" class="section">
    <div class="section-header">
        <h2 class="section-title">Wyniki - Zestawienie ≈örednich</h2>
        <div class="section-actions">
            <button class="btn btn-primary" id="export-results">Eksportuj do Excel</button>
            <button class="btn btn-success" id="refresh-results">Od≈õwie≈º Wyniki</button>
        </div>
    </div>
    
    <div class="class-info">
        <h3>Klasa: <span id="results-class-name">5B</span></h3>
        <p>Rok szkolny: 2025/2026</p>
    </div>
    
    <div class="results-filters">
        <label for="results-semester">Widok:</label>
        <select id="results-semester">
            <option value="all">Ca≈Çy rok</option>
            <option value="1">Tylko I semestr</option>
            <option value="2">Tylko II semestr</option>
        </select>
    </div>
    
    <div class="results-table-container">
        <table class="results-table" id="results-table">
            <thead id="results-table-head">
                <!-- Nag≈Ç√≥wki bƒôdƒÖ generowane dynamicznie -->
            </thead>
            <tbody id="results-table-body">
                <!-- Dane bƒôdƒÖ generowane dynamicznie -->
            </tbody>
        </table>
    </div>
    
    <div class="results-summary">
        <h3>Podsumowanie klasy</h3>
        <div id="class-summary">
            <p>≈örednia klasy I semestr: <span id="class-avg-sem1">-</span></p>
            <p>≈örednia klasy II semestr: <span id="class-avg-sem2">-</span></p>
            <p>≈örednia roczna klasy: <span id="class-avg-year">-</span></p>
        </div>
    </div>
</section>
            <section id="admin" class="section">
                <div class="section-header">
                    <h2 class="section-title">Panel Administratora</h2>
                </div>
                
                <div class="class-info">
                    <h3>Klasa: <span id="admin-class-name">5B</span></h3>
                </div>
                
                <div class="admin-panel">
                    <div class="admin-card">
                        <h3>ZarzƒÖdzanie Przedmiotami</h3>
                        <div class="form-group">
                            <input type="text" id="new-subject-name" placeholder="Nazwa przedmiotu">
                            <button class="btn btn-primary mt-20" id="add-subject">Dodaj Przedmiot</button>
                        </div>
                        <div class="class-list" id="subject-list"></div>
                    </div>
                    
                    <div class="admin-card">
                        <h3>ZarzƒÖdzanie Uczniami</h3>
                        <div class="form-group">
                            <textarea id="student-names" placeholder="Wpisz uczni√≥w (jeden na linijkƒô):&#10;Jan Kowalski&#10;Anna Nowak" rows="5"></textarea>
                            <button class="btn btn-primary mt-20" id="add-students">Dodaj Uczni√≥w</button>
                        </div>
                        <div class="student-list" id="student-list"></div>
                    </div>
                    
                    <div class="admin-card">
                        <h3>Kategorie Ocen</h3>
                        <div class="form-group">
                            <input type="text" id="new-category-name" placeholder="Nazwa kategorii">
                            <label for="category-color">Kolor:</label>
                            <input type="color" id="category-color" value="#3498db" class="color-picker">
                            <button class="btn btn-primary mt-20" id="add-category">Dodaj Kategoriƒô</button>
                        </div>
                        <div class="category-list" id="category-list"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="modal" id="lesson-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="lesson-modal-title">Szczeg√≥≈Çy Lekcji</h2>
                <button class="close-button" id="close-lesson-modal">&times;</button>
            </div>
            <div id="lesson-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="lesson-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="lesson-details-modal-title">Realizacja Lekcji</h2>
                <button class="close-button" id="close-lesson-details-modal">&times;</button>
            </div>
            <div id="lesson-details-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="schedule-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="schedule-modal-title">Dodaj Lekcjƒô do Planu</h2>
                <button class="close-button" id="close-schedule-modal">&times;</button>
            </div>
            <div id="schedule-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="grade-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="grade-modal-title">Dodaj Ocenƒô</h2>
                <button class="close-button" id="close-grade-modal">&times;</button>
            </div>
            <div id="grade-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="grade-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="grade-details-modal-title">Szczeg√≥≈Çy Oceny</h2>
                <button class="close-button" id="close-grade-details-modal">&times;</button>
            </div>
            <div id="grade-details-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="material-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="material-modal-title">Dodaj Tematy</h2>
                <button class="close-button" id="close-material-modal">&times;</button>
            </div>
            <div id="material-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="event-modal-title">Dodaj Wydarzenie</h2>
                <button class="close-button" id="close-event-modal">&times;</button>
            </div>
            <div id="event-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="event-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="event-details-modal-title">Szczeg√≥≈Çy Wydarzenia</h2>
                <button class="close-button" id="close-event-details-modal">&times;</button>
            </div>
            <div id="event-details-modal-body"></div>
        </div>
    </div>

    <div class="modal" id="substitution-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="substitution-modal-title">Dodaj Zastƒôpstwo</h2>
                <button class="close-button" id="close-substitution-modal">&times;</button>
            </div>
            <div id="substitution-modal-body"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrpLz8V_gfJlwAlLCY2BGEwkwraQ7wdH8",
            authDomain: "fslov-c8077.firebaseapp.com",
            databaseURL: "https://fslov-c8077-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fslov-c8077",
            storageBucket: "fslov-c8077.firebasestorage.app",
            messagingSenderId: "716688990498",
            appId: "1:716688990498:web:b819258bf3e379a5c6057b",
            measurementId: "G-7R291WZ36K"
        };

        let database, dbRef;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            dbRef = database.ref('classDiary');
            console.log('‚úÖ Firebase zainicjalizowany poprawnie');
        } catch (error) {
            console.error('‚ùå B≈ÇƒÖd inicjalizacji Firebase:', error);
        }

        const SCHOOL_YEAR = {
            start: '2025-09-01',
            end: '2026-06-26'
        };

        const GRADE_VALUES = {
            '1': 1.0, '1+': 1.5, '2-': 1.75, '2': 2.0, '2+': 2.5,
            '3-': 2.75, '3': 3.0, '3+': 3.5, '4-': 3.75, '4': 4.0,
            '4+': 4.5, '5-': 4.75, '5': 5.0, '5+': 5.5, '6-': 5.75, '6': 6.0,
            '.1': null, '.1+': null, '.2-': null, '.2': null, '.2+': null,
            '.3-': null, '.3': null, '.3+': null, '.4-': null, '.4': null,
            '.4+': null, '.5-': null, '.5': null, '.5+': null, '.6-': null, '.6': null,
            'np': null, 'nb': null, 'zw': null, '+': null, '-': null
        };

        const GRADE_OPTIONS = [
            '1', '1+', '2-', '2', '2+', '3-', '3', '3+', '4-', '4', '4+', '5-', '5', '5+', '6-', '6',
            '.1', '.1+', '.2-', '.2', '.2+', '.3-', '.3', '.3+', '.4-', '.4', '.4+', '.5-', '.5', '.5+', '.6-', '.6',
            'np', 'nb', 'zw', '+', '-'
        ];

        let appData = {
            className: "5B",
            classTeacher: "Mateusz Gig",
            subjects: ["Matematyka", "Jƒôzyk polski", "Historia", "Geografia", "Biologia", "Fizyka", "Chemia", "Jƒôzyk angielski"],
            students: [],
            schedule: { standard: {}, actual: {} },
            material: {},
            grades: {},
            events: [],
            categories: [
                { name: 'Odpowied≈∫ ustna', color: '#3498db' },
                { name: 'Kartk√≥wka', color: '#9b59b6' },
                { name: 'Sprawdzian', color: '#e74c3c' },
                { name: 'Praca domowa', color: '#f39c12' },
                { name: 'Aktywno≈õƒá', color: '#27ae60' }
            ]
        };

        let currentWeek;
        let currentEditingCell = null;
        let currentSubstitutionData = null;

        async function migrateFromLocalStorage(firebaseData) {
            try {
                if (firebaseData && firebaseData.className) {
                    console.log('‚ÑπÔ∏è Firebase ju≈º ma dane, pomijam migracjƒô');
                    return null;
                }
                
                const localData = localStorage.getItem('classDiary');
                
                if (localData) {
                    console.log('üîÑ Migracja z localStorage...');
                    const parsedData = JSON.parse(localData);
                    await dbRef.set(parsedData);
                    console.log('‚úÖ Migracja zako≈Ñczona');
                    alert('‚úÖ Dane przeniesione do Firebase!');
                    return parsedData;
                }
                return null;
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd migracji:', error);
                return null;
            }
        }

        async function loadDataFromFirebase() {
            try {
                console.log('‚è≥ ≈Åadowanie danych...');
                const snapshot = await dbRef.once('value');
                const data = snapshot.val();
                
                const migratedData = await migrateFromLocalStorage(data);
                
                if (data && data.className) {
                    appData = data;
                } else if (migratedData) {
                    appData = migratedData;
                } else {
                    await saveData();
                }
                
                if (!appData.schedule) appData.schedule = { standard: {}, actual: {} };
                if (!appData.schedule.standard) appData.schedule.standard = {};
                if (!appData.schedule.actual) appData.schedule.actual = {};
                if (!appData.students) appData.students = [];
                if (!appData.grades) appData.grades = {};
                if (!appData.material) appData.material = {};
                if (!appData.events) appData.events = [];
                if (!appData.subjects) appData.subjects = ["Matematyka"];
                if (!appData.categories) appData.categories = [
                    { name: 'Odpowied≈∫ ustna', color: '#3498db' }
                ];
                
                document.getElementById('loader').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    alert('B≈ÅƒÑD: Brak uprawnie≈Ñ! Ustaw regu≈Çy w Firebase.');
                }
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function saveData() {
    try {
        console.log('üíæ Pr√≥bujƒô zapisaƒá dane...');
        console.log('üì¶ Dane do zapisu:', appData);
        console.log('üìÖ Liczba wydarze≈Ñ:', appData.events.length);
        
        await dbRef.set(appData);
        
        console.log('‚úÖ Zapisano do Firebase!');
        showNotification('Zapisano!');
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd zapisu:', error);
        console.error('Szczeg√≥≈Çy:', error.message);
        console.error('Kod b≈Çƒôdu:', error.code);
        alert('B≈ÇƒÖd zapisu: ' + error.message);
    }
}

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: #27ae60; color: white;
                padding: 15px 20px; border-radius: 5px;
                z-index: 10000; animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        function getCurrentWeek() {
            const today = new Date();
            const start = new Date(today);
            start.setHours(12, 0, 0, 0);
            const day = start.getDay();
            const diff = start.getDate() - day + (day === 0 ? -6 : 1);
            start.setDate(diff);
            const end = new Date(start);
            end.setDate(start.getDate() + 4);
            return { start, end };
        }

        async function initApp() {
            currentWeek = getCurrentWeek();
            await loadDataFromFirebase();
            setupEventListeners();
            loadInitialData();
            showSection('home');
            generateWeeklyCalendar();
            loadUpcomingEvents();
            updateClassInfo();
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => showSection(tab.getAttribute('data-tab')));
            });

            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeek.start.setDate(currentWeek.start.getDate() - 7);
                currentWeek.end.setDate(currentWeek.end.getDate() - 7);
                generateWeeklyCalendar();
                loadUpcomingEvents();
            });
			// Dodaj to w funkcji setupEventListeners():

document.getElementById('results-semester').addEventListener('change', loadResults);
document.getElementById('refresh-results').addEventListener('click', loadResults);
document.getElementById('export-results').addEventListener('click', exportResults);

            document.getElementById('next-week').addEventListener('click', () => {
                currentWeek.start.setDate(currentWeek.start.getDate() + 7);
                currentWeek.end.setDate(currentWeek.end.getDate() + 7);
                generateWeeklyCalendar();
                loadUpcomingEvents();
            });

            document.getElementById('close-lesson-modal').addEventListener('click', () => {
                document.getElementById('lesson-modal').style.display = 'none';
            });
            document.getElementById('close-lesson-details-modal').addEventListener('click', () => {
                document.getElementById('lesson-details-modal').style.display = 'none';
            });
            document.getElementById('close-schedule-modal').addEventListener('click', () => {
                document.getElementById('schedule-modal').style.display = 'none';
            });
            document.getElementById('close-grade-modal').addEventListener('click', () => {
                document.getElementById('grade-modal').style.display = 'none';
            });
            document.getElementById('close-grade-details-modal').addEventListener('click', () => {
                document.getElementById('grade-details-modal').style.display = 'none';
            });
            document.getElementById('close-material-modal').addEventListener('click', () => {
                document.getElementById('material-modal').style.display = 'none';
            });
            document.getElementById('close-event-modal').addEventListener('click', () => {
                document.getElementById('event-modal').style.display = 'none';
            });
            document.getElementById('close-event-details-modal').addEventListener('click', () => {
                document.getElementById('event-details-modal').style.display = 'none';
            });
            document.getElementById('close-substitution-modal').addEventListener('click', () => {
                document.getElementById('substitution-modal').style.display = 'none';
            });

            document.getElementById('add-subject').addEventListener('click', addSubject);
            document.getElementById('add-students').addEventListener('click', addStudents);
            document.getElementById('add-category').addEventListener('click', addCategory);
            document.getElementById('add-material').addEventListener('click', showMaterialForm);
            document.getElementById('add-grade-bulk').addEventListener('click', showBulkGradeForm);
            document.getElementById('add-grade-single').addEventListener('click', showSingleGradeForm);
            document.getElementById('add-event-btn').addEventListener('click', () => showEventForm());

            document.getElementById('material-subject').addEventListener('change', loadMaterial);
            document.getElementById('grade-subject').addEventListener('change', loadGrades);
            document.getElementById('grade-semester').addEventListener('change', loadGrades);
            document.getElementById('grade-category').addEventListener('change', loadGrades);
        }

        function loadInitialData() {
            loadSubjects();
            loadSchedule();
            loadGrades();
        }

        function updateClassInfo() {
    document.querySelectorAll('#current-class-name, #schedule-class-name, #material-class-name, #grades-class-name, #admin-class-name, #results-class-name').forEach(el => {
        if (el) el.textContent = appData.className;
    });
    const classTeacher = document.getElementById('class-teacher');
    if (classTeacher) classTeacher.textContent = appData.classTeacher;
}

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            document.querySelector(`[data-tab="${sectionName}"]`).classList.add('active');

              if (sectionName === 'grades') loadGrades();
    else if (sectionName === 'material') loadMaterial();
    else if (sectionName === 'admin') loadAdminData();
    else if (sectionName === 'schedule') loadSchedule();
    else if (sectionName === 'results') loadResults();  // DODAJ Tƒò LINIƒò
    else if (sectionName === 'home') {
        generateWeeklyCalendar();
        loadUpcomingEvents();
    }
}

        function generateWeeklyCalendar() {
            const calendarBody = document.getElementById('calendar-body');
            const weekRangeElement = document.getElementById('week-range');
            
            const options = { day: 'numeric', month: 'long' };
            weekRangeElement.textContent = 
                `${currentWeek.start.toLocaleDateString('pl-PL', options)} - ${currentWeek.end.toLocaleDateString('pl-PL', options)}`;
            
            calendarBody.innerHTML = '';
            
            for (let hour = 1; hour <= 10; hour++) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="time-header">${hour}</td>`;
                
                for (let day = 0; day < 5; day++) {
                    const cellDate = new Date(currentWeek.start);
                    cellDate.setDate(currentWeek.start.getDate() + day);
                    
                    const cell = document.createElement('td');
                    const dateKey = formatDate(cellDate);
                    const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                    const dayName = dayNames[day];
                    
                    const actualLesson = appData.schedule.actual[dateKey] && appData.schedule.actual[dateKey][hour];
                    const standardLesson = appData.schedule.standard[dayName] && appData.schedule.standard[dayName][hour];
                    const lesson = actualLesson || standardLesson;
                    
                    const events = getEventsForDateAndHour(dateKey, hour);
                    
                    if (lesson) {
                        const lessonClass = getLessonClass(lesson.status || 'normal');
                        let statusText = '';
                        
                        if (lesson.status === 'cancelled') statusText = 'Odwo≈Çana';
                        else if (lesson.status === 'substitution') statusText = 'Zastƒôpstwo';
                        else if (lesson.status === 'substitute_for') statusText = 'Zastƒôpujƒô za: ' + lesson.substituteFor;
                        else if (lesson.status === 'completed') statusText = 'Zrealizowana';
                        
                        cell.innerHTML = `
                            <div class="lesson-item ${lessonClass}" data-date="${dateKey}" data-hour="${hour}">
                                <div class="lesson-class">${lesson.subject}</div>
                                ${lesson.topic ? `<div class="lesson-topic">${lesson.topic}</div>` : ''}
                                ${statusText ? `<div class="lesson-status">${statusText}</div>` : ''}
                                ${events.length > 0 ? `<div class="event-badge">!</div>` : ''}
                                ${lesson.hasGrades ? `<div class="grade-indicator">‚úì</div>` : ''}
                                ${lesson.hasQuiz ? `<div class="quiz-indicator">Q</div>` : ''}
                            </div>
                        `;
                        
                        if (events.length > 0) {
                            events.forEach(event => {
                                const eventElement = document.createElement('div');
                                eventElement.className = 'event-item';
                                eventElement.setAttribute('data-event-id', event.id);
                                eventElement.innerHTML = `<div class="event-item-title">${event.title}</div>`;
                                eventElement.addEventListener('click', () => showEventDetails(event.id));
                                cell.appendChild(eventElement);
                            });
                        }
                        
                        cell.querySelector('.lesson-item').addEventListener('click', () => {
                            showLessonDetails(dateKey, hour, lesson, events);
                        });
                    } else {
                        cell.innerHTML = `<div class="lesson-item" data-date="${dateKey}" data-hour="${hour}"></div>`;
                        cell.querySelector('.lesson-item').addEventListener('click', () => {
                            showSubstitutionForm(dateKey, hour);
                        });
                        
                        if (events.length > 0) {
                            events.forEach(event => {
                                const eventElement = document.createElement('div');
                                eventElement.className = 'event-item';
                                eventElement.setAttribute('data-event-id', event.id);
                                eventElement.innerHTML = `<div class="event-item-title">${event.title}</div>`;
                                eventElement.addEventListener('click', () => showEventDetails(event.id));
                                cell.appendChild(eventElement);
                            });
                        }
                    }
                    
                    row.appendChild(cell);
                }
                
                calendarBody.appendChild(row);
            }
        }

        function getEventsForDateAndHour(date, hour) {
            return appData.events.filter(event => {
                return event.date === date && (!event.lesson || event.lesson == hour);
            });
        }

        function getLessonClass(status) {
    switch(status) {
        case 'normal': return 'lesson-normal';
        case 'substitution': return 'lesson-substitution';
        case 'substitute_for': return 'lesson-substitute-for';
        case 'subject_substitution': return 'lesson-substitution';
        case 'completed': return 'lesson-completed';
        case 'cancelled': return 'lesson-cancelled';
        case 'exam': return 'lesson-exam';
        case 'quiz': return 'lesson-quiz';
        default: return 'lesson-normal';
    }
}

        function loadSchedule() {
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = '';
            
            for (let hour = 1; hour <= 10; hour++) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="time-header">${hour}</td>`;
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                
                days.forEach(day => {
                    const cell = document.createElement('td');
                    cell.setAttribute('data-day', day);
                    cell.setAttribute('data-hour', hour);
                    
                    const lesson = appData.schedule.standard[day] && appData.schedule.standard[day][hour];
                    
                    if (lesson) {
                        cell.innerHTML = `<div class="schedule-lesson"><strong>${lesson.subject}</strong></div>`;
                    }
                    
                    cell.addEventListener('click', () => showScheduleLessonForm(day, hour, lesson));
                    row.appendChild(cell);
                });
                
                scheduleBody.appendChild(row);
            }
        }

        function showScheduleLessonForm(day, hour, existingLesson = null) {
            currentEditingCell = { day, hour };
            const modal = document.getElementById('schedule-modal');
            const title = document.getElementById('schedule-modal-title');
            const body = document.getElementById('schedule-modal-body');
            
            title.textContent = existingLesson ? 'Edytuj Lekcjƒô' : 'Dodaj Lekcjƒô do Planu';
            
            body.innerHTML = `
                <div class="form-group">
                    <label for="schedule-subject">Przedmiot:</label>
                    <select id="schedule-subject" required>
                        <option value="">-- Wybierz przedmiot --</option>
                        ${appData.subjects.map(s => 
                            `<option value="${s}" ${existingLesson && existingLesson.subject === s ? 'selected' : ''}>${s}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-schedule">Anuluj</button>
                    <button class="btn btn-primary" id="save-schedule">${existingLesson ? 'Zapisz' : 'Dodaj'}</button>
                    ${existingLesson ? `<button class="btn btn-danger" id="delete-schedule">Usu≈Ñ</button>` : ''}
                </div>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('cancel-schedule').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('save-schedule').addEventListener('click', saveScheduleLesson);
            
            if (existingLesson) {
                document.getElementById('delete-schedule').addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô lekcjƒô z planu?')) {
                        delete appData.schedule.standard[day][hour];
                        if (Object.keys(appData.schedule.standard[day]).length === 0) {
                            delete appData.schedule.standard[day];
                        }
                        saveData();
                        loadSchedule();
                        modal.style.display = 'none';
                    }
                });
            }
        }

        function saveScheduleLesson() {
            const day = currentEditingCell.day;
            const hour = currentEditingCell.hour;
            const subject = document.getElementById('schedule-subject').value;
            
            if (!subject) {
                alert('Proszƒô wybraƒá przedmiot');
                return;
            }
            
            if (!appData.schedule.standard[day]) {
                appData.schedule.standard[day] = {};
            }
            
            appData.schedule.standard[day][hour] = { subject: subject };
            
            saveData();
            loadSchedule();
            document.getElementById('schedule-modal').style.display = 'none';
        }

        function showLessonDetails(date, hour, lesson, events) {
            const modal = document.getElementById('lesson-modal');
            const title = document.getElementById('lesson-modal-title');
            const body = document.getElementById('lesson-modal-body');
            
            title.textContent = 'Szczeg√≥≈Çy Lekcji';
            
            let content = '';
            
            if (lesson) {
                content += `
                    <div class="grade-details">
                        <h3>Lekcja:</h3>
                        <p><strong>Przedmiot:</strong> ${lesson.subject}</p>
                        ${lesson.topic ? `<p><strong>Temat:</strong> ${lesson.topic}</p>` : ''}
                        <p><strong>Data:</strong> ${formatDisplayDate(date)}</p>
                        <p><strong>Godzina:</strong> ${hour}</p>
                        ${lesson.notes ? `<p><strong>Uwagi:</strong> ${lesson.notes}</p>` : ''}
                        ${lesson.hasGrades ? `<p><strong>‚úì Dodano oceny</strong></p>` : ''}
                        ${lesson.hasQuiz ? `<p><strong>‚úì Zapowiedziana kartk√≥wka/sprawdzian</strong></p>` : ''}
                    </div>
                `;
                
                if (lesson.status === 'substitute_for') {
                    content += `
                        <div class="substitution-details">
                            <p><strong>Zastƒôpujƒô za:</strong> ${lesson.substituteFor}</p>
                        </div>
                    `;
                }
            }
            
            if (events.length > 0) {
                content += `<div class="grade-details"><h3>Wydarzenia:</h3>`;
                events.forEach(event => {
                    const category = appData.categories.find(c => c.name === event.category);
                    const color = category ? category.color : '#3498db';
                    content += `
                        <div style="border-left: 4px solid ${color}; padding-left: 10px; margin-bottom: 10px;">
                            <p><strong>${event.title}</strong></p>
                            <p>${event.description || 'Brak opisu'}</p>
                            <p><small>Kategoria: ${event.category}</small></p>
                        </div>
                    `;
                });
                content += `</div>`;
            }
            
            content += `
                <div class="form-actions">
                    <button class="btn btn-primary" id="edit-lesson-details">Realizacja Lekcji</button>
                    <button class="btn btn-secondary" id="close-details">Zamknij</button>
                </div>
            `;
            
            body.innerHTML = content;
            modal.style.display = 'flex';
            
            document.getElementById('close-details').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('edit-lesson-details').addEventListener('click', () => {
                modal.style.display = 'none';
                showLessonRealizationForm(date, hour, lesson);
            });
        }

        function showLessonRealizationForm(date, hour, lesson) {
            const modal = document.getElementById('lesson-details-modal');
            const title = document.getElementById('lesson-details-modal-title');
            const body = document.getElementById('lesson-details-modal-body');
			
            
            title.textContent = 'Realizacja Lekcji';
            
            const materialKey = `${lesson.subject}`;
            const material = appData.material[materialKey] || [];
            
            body.innerHTML = `
                <div class="lesson-details-section">
                    <h3>Wybierz temat lekcji:</h3>
                    <div class="topic-list">
                        ${material.length > 0 ? material.map((topic, index) => `
                            <div class="topic-item ${topic.completed ? 'completed' : ''}">
                                <input type="checkbox" class="topic-checkbox" data-index="${index}" ${topic.completed ? 'checked' : ''}>
                                <span>${topic.topic}</span>
                                ${topic.date ? `<small>(${formatDisplayDate(topic.date)})</small>` : ''}
                            </div>
                        `).join('') : '<p>Brak temat√≥w w rozk≈Çadzie materia≈Çu</p>'}
                    </div>
                </div>
                
                <div class="lesson-details-section">
    <h3>Status lekcji:</h3>
    <div class="form-group">
        <select id="lesson-status">
            <option value="completed" ${lesson.status === 'completed' ? 'selected' : ''}>Zrealizowana normalnie</option>
            <option value="cancelled" ${lesson.status === 'cancelled' ? 'selected' : ''}>Odwo≈Çana</option>
            <option value="substitution" ${lesson.status === 'substitution' ? 'selected' : ''}>Zastƒôpstwo (inny nauczyciel)</option>
            <option value="subject_substitution" ${lesson.status === 'subject_substitution' ? 'selected' : ''}>Zastƒôpstwo przedmiotowe</option>
        </select>
    </div>
    
    <div id="subject-substitution-container" style="display: ${lesson.status === 'subject_substitution' ? 'block' : 'none'};">
        <div class="form-group">
            <label for="substitution-subject-select">Przedmiot na zastƒôpstwie:</label>
            <select id="substitution-subject-select">
                <option value="">-- Wybierz przedmiot --</option>
                ${appData.subjects.map(s => `<option value="${s}" ${lesson.substitutionSubject === s ? 'selected' : ''}>${s}</option>`).join('')}
            </select>
        </div>
    </div>
                    
                    <div id="substitute-for-container" style="display: ${lesson.status === 'substitute_for' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label for="substitute-for">Zastƒôpujƒô za:</label>
                            <input type="text" id="substitute-for" value="${lesson.substituteFor || ''}" placeholder="Imiƒô i nazwisko nauczyciela">
                        </div>
                    </div>
                </div>
                
                <div class="lesson-details-section">
                    <h3>Dodatkowe informacje:</h3>
                    <div class="form-group">
                        <textarea id="lesson-notes" rows="3" placeholder="Dodatkowe uwagi o lekcji...">${lesson.notes || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="lesson-has-grades" ${lesson.hasGrades ? 'checked' : ''}>
                            Dodano oceny na tej lekcji?
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="lesson-has-quiz" ${lesson.hasQuiz ? 'checked' : ''}>
                            Zapowiedziana praca klasowa?
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-lesson-realization">Anuluj</button>
                    <button class="btn btn-primary" id="save-lesson-realization">Zapisz</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Event listener dla zmiany statusu lekcji
document.getElementById('lesson-status').addEventListener('change', function() {
    document.getElementById('substitute-for-container').style.display = 
        this.value === 'substitute_for' ? 'block' : 'none';
    document.getElementById('subject-substitution-container').style.display = 
        this.value === 'subject_substitution' ? 'block' : 'none';
    
    // Dynamicznie ≈Çaduj tematy dla wybranego przedmiotu
    if (this.value === 'subject_substitution') {
        updateTopicsForSubstitution();
    }
});

// TUTAJ DODAJ PUNKT 4:
const substitutionSubjectSelect = document.getElementById('substitution-subject-select');
if (substitutionSubjectSelect) {
    substitutionSubjectSelect.addEventListener('change', updateTopicsForSubstitution);
}

// A tutaj ju≈º sƒÖ inne event listenery
document.getElementById('cancel-lesson-realization').addEventListener('click', () => {
    modal.style.display = 'none';
});

document.getElementById('save-lesson-realization').addEventListener('click', () => {
    saveLessonRealization(date, hour, lesson, materialKey);
});
        }
function updateTopicsForSubstitution() {
    const substitutionSubject = document.getElementById('substitution-subject-select').value;
    const topicList = document.querySelector('.topic-list');
    
    if (!substitutionSubject) {
        topicList.innerHTML = '<p>Wybierz przedmiot zastƒôpstwa</p>';
        return;
    }
    
    const materialKey = substitutionSubject;
    const material = appData.material[materialKey] || [];
    
    topicList.innerHTML = material.length > 0 ? material.map((topic, index) => `
        <div class="topic-item ${topic.completed ? 'completed' : ''}">
            <input type="checkbox" class="topic-checkbox" data-index="${index}" ${topic.completed ? 'checked' : ''}>
            <span>${topic.topic}</span>
            ${topic.date ? `<small>(${formatDisplayDate(topic.date)})</small>` : ''}
        </div>
    `).join('') : '<p>Brak temat√≥w w rozk≈Çadzie materia≈Çu dla tego przedmiotu</p>';
}

       function saveLessonRealization(date, hour, lesson, materialKey) {
    const status = document.getElementById('lesson-status').value;
    const substituteFor = document.getElementById('substitute-for').value;
    const notes = document.getElementById('lesson-notes').value;
    const hasGrades = document.getElementById('lesson-has-grades').checked;
    const hasQuiz = document.getElementById('lesson-has-quiz').checked;
    
    // Dla zastƒôpstwa przedmiotowego
    let substitutionSubject = null;
    let actualMaterialKey = materialKey;
    
    if (status === 'subject_substitution') {
        substitutionSubject = document.getElementById('substitution-subject-select').value;
        if (!substitutionSubject) {
            alert('Wybierz przedmiot na zastƒôpstwie');
            return;
        }
        actualMaterialKey = substitutionSubject;
    }
    
    if (!appData.schedule.actual[date]) {
        appData.schedule.actual[date] = {};
    }
    
    // Zachowaj oryginalny przedmiot lub przywr√≥ƒá go je≈õli wracamy do statusu normalnego
    let originalSubject = lesson.originalSubject || lesson.subject;
    
    // Usu≈Ñ "(Zastƒôpstwo)" z nazwy przedmiotu je≈õli tam jest
    if (originalSubject.includes(' (Zastƒôpstwo)')) {
        originalSubject = originalSubject.replace(' (Zastƒôpstwo)', '');
    }
    
    const lessonData = {
        ...lesson,
        status: status,
        notes: notes,
        hasGrades: hasGrades,
        hasQuiz: hasQuiz,
        originalSubject: originalSubject  // Zawsze zachowuj oryginalny przedmiot
    };
    
    // Dodaj informacjƒô o zastƒôpstwie przedmiotowym
    if (status === 'subject_substitution' && substitutionSubject) {
        lessonData.substitutionSubject = substitutionSubject;
        lessonData.subject = `${substitutionSubject} (Zastƒôpstwo)`;
    } else {
        // Dla innych status√≥w przywr√≥ƒá oryginalny przedmiot
        lessonData.subject = originalSubject;
        // Usu≈Ñ dane o zastƒôpstwie je≈õli zmieniamy status
        delete lessonData.substitutionSubject;
    }
    
    // Dodaj substituteFor tylko je≈õli status to 'substitute_for' I pole jest wype≈Çnione
    if (status === 'substitute_for' && substituteFor) {
        lessonData.substituteFor = substituteFor;
    }
    
    // Dodaj completedDate tylko dla statusu 'completed'
    if (status === 'completed') {
        lessonData.completedDate = date;
    }
    
    appData.schedule.actual[date][hour] = lessonData;
    
    const checkboxes = document.querySelectorAll('.topic-checkbox');
checkboxes.forEach(checkbox => {
    const index = parseInt(checkbox.getAttribute('data-index'));
    if (checkbox.checked && appData.material[actualMaterialKey] && appData.material[actualMaterialKey][index]) {
        appData.material[actualMaterialKey][index].completed = true;
        if (!appData.material[actualMaterialKey][index].date) {
            appData.material[actualMaterialKey][index].date = date;
        }
    }
});
    
    saveData();
    generateWeeklyCalendar();
    document.getElementById('lesson-details-modal').style.display = 'none';
}

        function showSubstitutionForm(date, hour) {
            currentSubstitutionData = { date, hour };
            const modal = document.getElementById('substitution-modal');
            const title = document.getElementById('substitution-modal-title');
            const body = document.getElementById('substitution-modal-body');
            
            title.textContent = 'Dodaj Zastƒôpstwo';
            
            body.innerHTML = `
                <div class="form-group">
                    <label for="substitution-subject">Przedmiot:</label>
                    <select id="substitution-subject" required>
                        <option value="">-- Wybierz przedmiot --</option>
                        ${appData.subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="substitution-type">Typ zastƒôpstwa:</label>
                    <select id="substitution-type" required>
                        <option value="">Zastƒôpstwo</option>
                        <option value="substitute_for">Zastƒôpujƒô za kogo≈õ</option>
                    </select>
                </div>
                <div id="substitute-for-input-container" style="display: none;">
                    <div class="form-group">
                        <label for="substitute-for-teacher">Zastƒôpujƒô za:</label>
                        <input type="text" id="substitute-for-teacher" placeholder="Imiƒô i nazwisko nauczyciela">
                    </div>
                </div>
                <div class="form-group">
                    <label for="substitution-topic">Temat lekcji:</label>
                    <input type="text" id="substitution-topic" placeholder="Temat lekcji (opcjonalnie)">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-substitution">Anuluj</button>
                    <button class="btn btn-primary" id="save-substitution">Dodaj Zastƒôpstwo</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('substitution-type').addEventListener('change', function() {
                document.getElementById('substitute-for-input-container').style.display = 
                    this.value === 'substitute_for' ? 'block' : 'none';
            });
            
            document.getElementById('cancel-substitution').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('save-substitution').addEventListener('click', saveSubstitution);
        }

       function saveSubstitution() {
    const date = currentSubstitutionData.date;
    const hour = currentSubstitutionData.hour;
    const subject = document.getElementById('substitution-subject').value;
    const type = document.getElementById('substitution-type').value;
    const substituteFor = document.getElementById('substitute-for-teacher').value;
    const topic = document.getElementById('substitution-topic').value;
    
    if (!subject) {
        alert('Proszƒô wybraƒá przedmiot');
        return;
    }
    
    if (type === 'substitute_for' && !substituteFor) {
        alert('Proszƒô wpisaƒá za kogo jest zastƒôpstwo');
        return;
    }
    
    if (!appData.schedule.actual[date]) {
        appData.schedule.actual[date] = {};
    }
    
    // Tworzenie obiektu z danymi zastƒôpstwa
    const substitutionData = {
        subject: subject,
        status: type || 'substitution',
        topic: topic || '',
        isSubstitution: true
    };
    
    // Dodaj substituteFor tylko je≈õli typ to 'substitute_for' I pole jest wype≈Çnione
    if (type === 'substitute_for' && substituteFor) {
        substitutionData.substituteFor = substituteFor;
    }
    
    appData.schedule.actual[date][hour] = substitutionData;
    
    saveData();
    generateWeeklyCalendar();
    document.getElementById('substitution-modal').style.display = 'none';
}

        function loadGrades() {
            const subject = document.getElementById('grade-subject').value;
            const semester = document.getElementById('grade-semester').value;
            const category = document.getElementById('grade-category').value;
            
            if (!subject) return;
            
            const gradeTableBody = document.getElementById('grade-table-body');
            gradeTableBody.innerHTML = '';
            
            const students = appData.students || [];
            const subjectGrades = appData.grades[subject] || {};
            
            students.forEach(student => {
    const row = document.createElement('tr');
    
    const nameCell = document.createElement('td');
    nameCell.className = 'student-name';
    nameCell.textContent = student;
    row.appendChild(nameCell);
    
    // POPRAWKA - konwertuj obiekt na tablicƒô je≈õli trzeba
    let sem1Grades = subjectGrades[student]?.['1'] || [];
    
    // Je≈õli to obiekt zamiast tablicy, konwertuj na tablicƒô
    if (!Array.isArray(sem1Grades)) {
        const gradesArray = new Array(20).fill(null);
        Object.keys(sem1Grades).forEach(key => {
            gradesArray[parseInt(key)] = sem1Grades[key];
        });
        sem1Grades = gradesArray;
    }
    
    const filteredSem1Grades = category === 'all' ? sem1Grades : sem1Grades.filter(g => g && g.category === category);
                
                for (let i = 0; i < 19; i++) {
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-cell';
                    gradeCell.setAttribute('data-student', student);
                    gradeCell.setAttribute('data-semester', '1');
                    gradeCell.setAttribute('data-index', i);
                    
                    if (filteredSem1Grades[i]) {
                        const categoryObj = appData.categories.find(c => c.name === filteredSem1Grades[i].category);
                        const color = categoryObj ? categoryObj.color : '#3498db';
                        gradeCell.style.backgroundColor = color;
                        gradeCell.style.color = 'white';
                        gradeCell.textContent = filteredSem1Grades[i].grade;
                    }
                    
                    gradeCell.addEventListener('click', () => {
                        showGradeDetails(student, subject, '1', i);
                    });
                    
                    row.appendChild(gradeCell);
                }
                
                const avg1Cell = document.createElement('td');
avg1Cell.className = 'average-cell';
avg1Cell.textContent = calculateAverage(filteredSem1Grades);
row.appendChild(avg1Cell);

// ‚úÖ DODAJ KONWERSJƒò DLA SEMESTRU 2:
let sem2Grades = subjectGrades[student]?.['2'] || [];

// Je≈õli to obiekt zamiast tablicy, konwertuj na tablicƒô
if (!Array.isArray(sem2Grades)) {
    const gradesArray = new Array(20).fill(null);
    Object.keys(sem2Grades).forEach(key => {
        gradesArray[parseInt(key)] = sem2Grades[key];
    });
    sem2Grades = gradesArray;
}

const filteredSem2Grades = category === 'all' ? sem2Grades : sem2Grades.filter(g => g && g.category === category);
                
                for (let i = 0; i < 19; i++) {
                    const gradeCell = document.createElement('td');
                    gradeCell.className = 'grade-cell';
                    gradeCell.setAttribute('data-student', student);
                    gradeCell.setAttribute('data-semester', '2');
                    gradeCell.setAttribute('data-index', i);
                    
                    if (filteredSem2Grades[i]) {
                        const categoryObj = appData.categories.find(c => c.name === filteredSem2Grades[i].category);
                        const color = categoryObj ? categoryObj.color : '#3498db';
                        gradeCell.style.backgroundColor = color;
                        gradeCell.style.color = 'white';
                        gradeCell.textContent = filteredSem2Grades[i].grade;
                    }
                    
                    gradeCell.addEventListener('click', () => {
                        showGradeDetails(student, subject, '2', i);
                    });
                    
                    row.appendChild(gradeCell);
                }
                
                const avg2Cell = document.createElement('td');
                avg2Cell.className = 'average-cell';
                avg2Cell.textContent = calculateAverage(filteredSem2Grades);
                row.appendChild(avg2Cell);
                
                const yearlyAvgCell = document.createElement('td');
                yearlyAvgCell.className = 'average-cell';
                const allGrades = [...filteredSem1Grades, ...filteredSem2Grades];
                yearlyAvgCell.textContent = calculateAverage(allGrades);
                row.appendChild(yearlyAvgCell);
                
                gradeTableBody.appendChild(row);
            });
        }

        function calculateAverage(grades) {
    // Konwersja na tablicƒô je≈õli to obiekt
    if (!Array.isArray(grades)) {
        const gradesArray = [];
        Object.keys(grades || {}).forEach(key => {
            if (grades[key]) gradesArray.push(grades[key]);
        });
        grades = gradesArray;
    }
    
    const validGrades = grades.filter(g => g && g.grade && GRADE_VALUES[g.grade] !== null);
    if (validGrades.length === 0) return '-';
    
    const sum = validGrades.reduce((total, grade) => {
        return total + GRADE_VALUES[grade.grade];
    }, 0);
    
    return (sum / validGrades.length).toFixed(2);
}

        function showGradeDetails(student, subject, semester, index) {
            const grade = appData.grades[subject]?.[student]?.[semester]?.[index];
            if (!grade) {
                showSingleGradeForm(student, subject, semester, index);
                return;
            }
            
            const modal = document.getElementById('grade-details-modal');
            const title = document.getElementById('grade-details-modal-title');
            const body = document.getElementById('grade-details-modal-body');
            
            title.textContent = 'Szczeg√≥≈Çy Oceny';
            
            const categoryObj = appData.categories.find(c => c.name === grade.category);
            const color = categoryObj ? categoryObj.color : '#3498db';
            
            body.innerHTML = `
                <div class="grade-details">
                    <p><strong>Ucze≈Ñ:</strong> ${student}</p>
                    <p><strong>Przedmiot:</strong> ${subject}</p>
                    <p><strong>Ocena:</strong> ${grade.grade}</p>
                    <p><strong>Kategoria:</strong> <span style="color: ${color}">${grade.category}</span></p>
                    <p><strong>Temat:</strong> ${grade.topic || 'Brak opisu'}</p>
                    <p><strong>Data:</strong> ${formatDisplayDate(grade.date)}</p>
                    <p><strong>Semestr:</strong> ${semester}</p>
                    <p><strong>Liczy siƒô do ≈õredniej:</strong> ${GRADE_VALUES[grade.grade] !== null ? 'TAK' : 'NIE'}</p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="edit-grade-details">Edytuj</button>
                    <button class="btn btn-danger" id="delete-grade-details">Usu≈Ñ</button>
                    <button class="btn btn-secondary" id="close-grade-details">Zamknij</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('close-grade-details').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('edit-grade-details').addEventListener('click', () => {
                modal.style.display = 'none';
                showSingleGradeForm(student, subject, semester, index);
            });
            
            document.getElementById('delete-grade-details').addEventListener('click', () => {
                if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô ocenƒô?')) {
                    delete appData.grades[subject][student][semester][index];
                    saveData();
                    loadGrades();
                    modal.style.display = 'none';
                }
            });
        }

        function showBulkGradeForm() {
            const subject = document.getElementById('grade-subject').value;
            if (!subject) {
                alert('Wybierz przedmiot najpierw');
                return;
            }
            
            const modal = document.getElementById('grade-modal');
            const title = document.getElementById('grade-modal-title');
            const body = document.getElementById('grade-modal-body');
            
            title.textContent = 'Dodaj Oceny Seryjnie';
            
            body.innerHTML = `
                <div class="grade-entry-form">
                    <div class="form-group">
                        <label for="bulk-topic">Temat/Opis:</label>
                        <input type="text" id="bulk-topic" required>
                    </div>
                    <div class="form-group">
                        <label for="bulk-category">Kategoria:</label>
                        <select id="bulk-category" required>
                            <option value="">-- Wybierz kategoriƒô --</option>
                            ${appData.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-semester">Semestr:</label>
                        <select id="bulk-semester" required>
                            <option value="1">Semestr I</option>
                            <option value="2">Semestr II</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-date">Data:</label>
                        <input type="date" id="bulk-date" required>
                    </div>
                </div>
                
                <div class="student-grades-entry">
                    <h4>Oceny dla uczni√≥w:</h4>
                    ${(appData.students || []).map(student => `
                        <div class="student-grade-row">
                            <span>${student}</span>
                            <select class="student-grade" data-student="${student}">
                                <option value="">-- Brak oceny --</option>
                                ${GRADE_OPTIONS.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-bulk-grade">Anuluj</button>
                    <button class="btn btn-primary" id="save-bulk-grade">Zapisz Oceny</button>
                </div>
            `;
            
            document.getElementById('bulk-date').value = new Date().toISOString().split('T')[0];
            
            modal.style.display = 'flex';
            
            document.getElementById('cancel-bulk-grade').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('save-bulk-grade').addEventListener('click', saveBulkGrades);
        }

        function saveBulkGrades() {
            const subject = document.getElementById('grade-subject').value;
            const topic = document.getElementById('bulk-topic').value;
            const category = document.getElementById('bulk-category').value;
            const semester = document.getElementById('bulk-semester').value;
            const date = document.getElementById('bulk-date').value;
            
            if (!topic || !category) {
                alert('Proszƒô wype≈Çniƒá wymagane pola');
                return;
            }
            
            if (!appData.grades[subject]) {
                appData.grades[subject] = {};
            }
            
            const students = appData.students || [];
            let gradesAdded = 0;
            
            students.forEach(student => {
                const gradeSelect = document.querySelector(`.student-grade[data-student="${student}"]`);
                const gradeValue = gradeSelect.value;
                
                if (gradeValue) {
                    if (!appData.grades[subject][student]) {
                        appData.grades[subject][student] = { '1': [], '2': [] };
                    }
                    
                    const semesterGrades = appData.grades[subject][student][semester];
                    let emptyIndex = -1;
                    
                    for (let i = 0; i < 19; i++) {
                        if (!semesterGrades[i]) {
                            emptyIndex = i;
                            break;
                        }
                    }
                    
                    if (emptyIndex !== -1) {
                        semesterGrades[emptyIndex] = {
                            grade: gradeValue,
                            category: category,
                            topic: topic,
                            date: date
                        };
                        gradesAdded++;
                    }
                }
            });
            
            if (gradesAdded > 0) {
                saveData();
                loadGrades();
                document.getElementById('grade-modal').style.display = 'none';
                alert(`Dodano ${gradesAdded} ocen`);
            } else {
                alert('Nie dodano ≈ºadnych ocen');
            }
        }

        function showSingleGradeForm(student = null, subject = null, semester = null, index = null) {
            const currentSubject = subject || document.getElementById('grade-subject').value;
            if (!currentSubject) {
                alert('Wybierz przedmiot najpierw');
                return;
            }
            
            const isEdit = !!(student && semester !== null && index !== null);
            const existingGrade = isEdit ? (appData.grades[currentSubject]?.[student]?.[semester]?.[index] || null) : null;
            
            const modal = document.getElementById('grade-modal');
            const title = document.getElementById('grade-modal-title');
            const body = document.getElementById('grade-modal-body');
            
            title.textContent = isEdit ? 'Edytuj Ocenƒô' : 'Dodaj Ocenƒô PojedynczƒÖ';
            
            body.innerHTML = `
                <div class="form-group">
                    <label for="single-student">Ucze≈Ñ:</label>
                    <select id="single-student" ${isEdit ? 'disabled' : ''} required>
                        <option value="">-- Wybierz ucznia --</option>
                        ${(appData.students || []).map(s => 
                            `<option value="${s}" ${isEdit && student === s ? 'selected' : ''}>${s}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="single-grade">Ocena:</label>
                    <select id="single-grade" required>
                        <option value="">-- Wybierz ocenƒô --</option>
                        ${GRADE_OPTIONS.map(grade => 
                            `<option value="${grade}" ${isEdit && existingGrade && existingGrade.grade === grade ? 'selected' : ''}>${grade}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="single-category">Kategoria:</label>
                    <select id="single-category" required>
                        <option value="">-- Wybierz kategoriƒô --</option>
                        ${appData.categories.map(c => 
                            `<option value="${c.name}" ${isEdit && existingGrade && existingGrade.category === c.name ? 'selected' : ''}>${c.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="single-topic">Temat/Opis:</label>
                    <input type="text" id="single-topic" value="${isEdit && existingGrade ? existingGrade.topic || '' : ''}">
                </div>
                <div class="form-group">
                    <label for="single-semester">Semestr:</label>
                    <select id="single-semester" ${isEdit ? 'disabled' : ''} required>
                        <option value="1" ${isEdit && semester === '1' ? 'selected' : ''}>Semestr I</option>
                        <option value="2" ${isEdit && semester === '2' ? 'selected' : ''}>Semestr II</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="single-date">Data:</label>
                    <input type="date" id="single-date" value="${isEdit && existingGrade ? existingGrade.date : new Date().toISOString().split('T')[0]}" required>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-single-grade">Anuluj</button>
                    <button class="btn btn-primary" id="save-single-grade">${isEdit ? 'Zapisz' : 'Dodaj'}</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('cancel-single-grade').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('save-single-grade').addEventListener('click', () => {
                saveSingleGrade(isEdit, student, currentSubject, semester, index);
            });
        }

        function saveSingleGrade(isEdit, student, subject, semester, index) {
            const currentStudent = isEdit ? student : document.getElementById('single-student').value;
            const grade = document.getElementById('single-grade').value;
            const category = document.getElementById('single-category').value;
            const topic = document.getElementById('single-topic').value;
            const currentSemester = isEdit ? semester : document.getElementById('single-semester').value;
            const date = document.getElementById('single-date').value;
            
            if (!currentStudent || !grade || !category) {
                alert('Proszƒô wype≈Çniƒá wymagane pola');
                return;
            }
            
            if (!appData.grades[subject]) {
                appData.grades[subject] = {};
            }
            
            if (!appData.grades[subject][currentStudent]) {
                appData.grades[subject][currentStudent] = { '1': [], '2': [] };
            }
            
            const gradeData = {
                grade: grade,
                category: category,
                topic: topic,
                date: date
            };
            
            if (isEdit) {
                appData.grades[subject][currentStudent][currentSemester][index] = gradeData;
            } else {
                const semesterGrades = appData.grades[subject][currentStudent][currentSemester];
                let emptyIndex = -1;
                
                for (let i = 0; i < 19; i++) {
                    if (!semesterGrades[i]) {
                        emptyIndex = i;
                        break;
                    }
                }
                
                if (emptyIndex !== -1) {
                    semesterGrades[emptyIndex] = gradeData;
                } else {
                    alert('Brak miejsca na nowe oceny w tym semestrze');
                    return;
                }
            }
            
            saveData();
            loadGrades();
            document.getElementById('grade-modal').style.display = 'none';
        }

        function loadMaterial() {
            const subject = document.getElementById('material-subject').value;
            
            if (!subject) return;
            
            const materialList = document.getElementById('material-list');
            materialList.innerHTML = '';
            
            const material = appData.material[subject] || [];
            
            if (material.length === 0) {
                materialList.innerHTML = '<div class="material-item">Brak materia≈Çu dla tego przedmiotu</div>';
                return;
            }
            
            material.forEach((item, index) => {
                const materialItem = document.createElement('div');
                materialItem.className = `material-item ${item.completed ? 'completed' : ''}`;
                
                materialItem.innerHTML = `
                    <div class="material-info">
                        <div class="material-topic">${item.topic}</div>
                        ${item.date ? `<div class="material-date">Zrealizowano: ${formatDisplayDate(item.date)}</div>` : ''}
                    </div>
                    <div class="material-actions">
                        <button class="btn btn-success small-btn complete-material" data-subject="${subject}" data-index="${index}">‚úì</button>
                        <button class="btn btn-danger small-btn delete-material" data-subject="${subject}" data-index="${index}">üóë</button>
                    </div>
                `;
                
                materialList.appendChild(materialItem);
            });
            
            document.querySelectorAll('.complete-material').forEach(btn => {
                btn.addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    const index = parseInt(this.getAttribute('data-index'));
                    completeMaterial(subject, index);
                });
            });
            
            document.querySelectorAll('.delete-material').forEach(btn => {
                btn.addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteMaterial(subject, index);
                });
            });
        }

        function showMaterialForm() {
            const subject = document.getElementById('material-subject').value;
            
            if (!subject) {
                alert('Wybierz przedmiot najpierw');
                return;
            }
            
            const modal = document.getElementById('material-modal');
            const title = document.getElementById('material-modal-title');
            const body = document.getElementById('material-modal-body');
            
            title.textContent = 'Dodaj Tematy';
            
            body.innerHTML = `
                <div class="form-group">
                    <label for="material-topics">Tematy (jeden na linijkƒô):</label>
                    <textarea id="material-topics" class="material-topics-input" placeholder="Wpisz tematy, ka≈ºdy w nowej linii"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-material">Anuluj</button>
                    <button class="btn btn-primary" id="save-material">Dodaj Tematy</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('cancel-material').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            document.getElementById('save-material').addEventListener('click', () => {
                saveMaterial(subject);
            });
        }

        function saveMaterial(subject) {
            const topicsText = document.getElementById('material-topics').value;
            
            if (!topicsText) {
                alert('Proszƒô wpisaƒá tematy');
                return;
            }
            
            const topics = topicsText.split('\n')
                .map(topic => topic.trim())
                .filter(topic => topic.length > 0);
            
            if (topics.length === 0) {
                alert('Nie znaleziono poprawnych temat√≥w');
                return;
            }
            
            if (!appData.material[subject]) {
                appData.material[subject] = [];
            }
            
            topics.forEach(topic => {
                appData.material[subject].push({
                    topic: topic,
                    completed: false,
                    date: null
                });
            });
            
            saveData();
            loadMaterial();
            document.getElementById('material-modal').style.display = 'none';
            alert(`Dodano ${topics.length} temat√≥w`);
        }

        function completeMaterial(subject, index) {
            if (appData.material[subject] && appData.material[subject][index]) {
                appData.material[subject][index].completed = true;
                appData.material[subject][index].date = new Date().toISOString().split('T')[0];
                saveData();
                loadMaterial();
            }
        }

        function deleteMaterial(subject, index) {
            if (confirm('Czy na pewno chcesz usunƒÖƒá ten temat?')) {
                appData.material[subject].splice(index, 1);
                saveData();
                loadMaterial();
            }
        }

        function loadUpcomingEvents() {
            const upcomingList = document.getElementById('upcoming-events-list');
            upcomingList.innerHTML = '';
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingEvents = appData.events.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate >= today && eventDate <= nextWeek;
            });
            
            if (upcomingEvents.length === 0) {
                upcomingList.innerHTML = '<div class="event-card">Brak nadchodzƒÖcych wydarze≈Ñ</div>';
                return;
            }
            
            upcomingEvents.forEach(event => {
                const categoryObj = appData.categories.find(c => c.name === event.category);
                const color = categoryObj ? categoryObj.color : '#3498db';
                
                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                eventCard.style.borderLeftColor = color;
                
                eventCard.innerHTML = `
                    <div class="event-title">${event.title}</div>
                    <div class="event-date">${formatDisplayDate(event.date)}</div>
                    <div class="event-description">${event.description}</div>
                `;
                
                upcomingList.appendChild(eventCard);
            });
        }
function showEventForm(eventId) {
    const modal = document.getElementById('event-modal');
    const title = document.getElementById('event-modal-title');
    const body = document.getElementById('event-modal-body');
    
    const isEdit = eventId ? true : false;
    const event = isEdit ? appData.events.find(e => e.id === eventId) : null;
    
    title.textContent = isEdit ? 'Edytuj Wydarzenie' : 'Dodaj Wydarzenie';
    
    body.innerHTML = `
        <div class="form-group">
            <label for="event-subject">Przedmiot:</label>
            <select id="event-subject" required>
                <option value="">-- Wybierz przedmiot --</option>
                ${appData.subjects.map(s => 
                    `<option value="${s}" ${isEdit && event && event.subject === s ? 'selected' : ''}>${s}</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label for="event-category">Wyb√≥r kategorii:</label>
            <select id="event-category" required>
                <option value="">-- Wybierz kategoriƒô --</option>
                ${appData.categories.map(c => 
                    `<option value="${c.name}" ${isEdit && event && event.category === c.name ? 'selected' : ''}>${c.name}</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label for="event-entry-date">Data wpisania:</label>
            <input type="date" id="event-entry-date" value="${isEdit && event ? event.entryDate : new Date().toISOString().split('T')[0]}" required>
        </div>
        <div class="form-group">
            <label for="event-date">Data wydarzenia:</label>
            <input type="date" id="event-date" value="${isEdit && event ? event.date : ''}" required>
        </div>
        <div class="form-group">
            <label for="event-description">Opis:</label>
            <textarea id="event-description" rows="3" placeholder="Opis wydarzenia">${isEdit && event && event.description ? event.description : ''}</textarea>
        </div>
        <div class="form-group">
            <label for="event-lesson">Lekcja (opcjonalnie):</label>
            <select id="event-lesson">
                <option value="">-- Nie przypisuj do lekcji --</option>
                ${Array.from({length: 10}, (_, i) => i + 1).map(h => 
                    `<option value="${h}" ${isEdit && event && event.lesson == h ? 'selected' : ''}>Lekcja ${h}</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-actions">
            <button class="btn btn-secondary" id="cancel-event">Anuluj</button>
            <button class="btn btn-primary" id="save-event">${isEdit ? 'Zapisz' : 'Dodaj'}</button>
        </div>
    `;
    
    modal.style.display = 'flex';
    
    document.getElementById('cancel-event').addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    document.getElementById('save-event').addEventListener('click', () => {
        saveEvent(eventId);
    });
}


     function saveEvent(eventId = null) {
    console.log('üéØ START saveEvent()');
    
    // Zabezpieczenie - je≈õli eventId to Event, ustaw na null
    if (eventId && eventId instanceof Event) {
        console.log('‚ö†Ô∏è eventId to Ev 	ent, ustawiam na null');
        eventId = null;
    }
    
    const subject = document.getElementById('event-subject').value;
    const category = document.getElementById('event-category').value;
    const entryDate = document.getElementById('event-entry-date').value;
    const eventDate = document.getElementById('event-date').value;
    const description = document.getElementById('event-description').value;
    const lesson = document.getElementById('event-lesson').value;
    
    console.log('üìù Warto≈õci z formularza:', {
        subject, category, entryDate, eventDate, description, lesson
    });
    
    if (!subject || !category || !eventDate) {
        console.log('‚ùå Walidacja nie przesz≈Ça!');
        alert('Proszƒô wype≈Çniƒá wymagane pola');
        return;
    }
    
    console.log('‚úÖ Walidacja OK');
    
    const eventData = {
        subject: subject,
        category: category,
        entryDate: entryDate,
        date: eventDate,
        description: description,
        lesson: lesson || null,
        title: `${subject} - ${category}`
    };
    
    console.log('üì¶ Utworzono eventData:', eventData);
    
    if (eventId && eventId !== null) {
        console.log('üìù Tryb EDYCJI, eventId:', eventId);
        const index = appData.events.findIndex(e => e.id === eventId);
        if (index !== -1) {
            appData.events[index] = {
                ...eventData,
                id: eventId
            };
            console.log('‚úÖ Zaktualizowano wydarzenie na pozycji', index);
        }
    } else {
        console.log('‚ûï Tryb DODAWANIA');
        const newEvent = {
            ...eventData,
            id: Date.now().toString()
        };
        console.log('üì¶ Nowe wydarzenie:', newEvent);
        
        appData.events.push(newEvent);
        console.log('‚úÖ Dodano do appData.events');
        console.log('üìä Teraz jest wydarze≈Ñ:', appData.events.length);
    }
    
    console.log('üíæ Wywo≈Çujƒô saveData()...');
    saveData();
    
    console.log('üîÑ Od≈õwie≈ºam kalendarz...');
    generateWeeklyCalendar();
    loadUpcomingEvents();
    
    console.log('‚ùå Zamykam modal...');
    document.getElementById('event-modal').style.display = 'none';
    
    console.log('üéØ KONIEC saveEvent()');
}

        function showEventDetails(eventId) {
            const event = appData.events.find(e => e.id === eventId);
            if (!event) return;
            
            const modal = document.getElementById('event-details-modal');
            const title = document.getElementById('event-details-modal-title');
            const body = document.getElementById('event-details-modal-body');
            
            title.textContent = 'Szczeg√≥≈Çy Wydarzenia';
            
            const categoryObj = appData.categories.find(c => c.name === event.category);
            const color = categoryObj ? categoryObj.color : '#3498db';
            
            body.innerHTML = `
    <div class="grade-details">
        <p><strong>Tytu≈Ç:</strong> ${event.title}</p>
        <p><strong>Przedmiot:</strong> ${event.subject}</p>
        <p><strong>Kategoria:</strong> <span style="color: ${color}">${event.category}</span></p>
        <p><strong>Data wpisania:</strong> ${formatDisplayDate(event.entryDate)}</p>
        <p><strong>Data wydarzenia:</strong> ${formatDisplayDate(event.date)}</p>
        ${event.lesson ? `<p><strong>Lekcja:</strong> ${event.lesson}</p>` : ''}
        <p><strong>Opis:</strong> ${event.description || 'Brak opisu'}</p>
    </div>
    <div class="form-actions">
        <button class="btn btn-primary" id="edit-event">Edytuj</button>
        <button class="btn btn-danger" id="delete-event">Usu≈Ñ</button>
        <button class="btn btn-secondary" id="close-event-details">Zamknij</button>
    </div>
`;
            
            modal.style.display = 'flex';
            
            document.getElementById('close-event-details').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            document.getElementById('edit-event').addEventListener('click', () => {
    modal.style.display = 'none';
    showEventForm(eventId);
});
            document.getElementById('delete-event').addEventListener('click', () => {
                if (confirm('Czy na pewno chcesz usunƒÖƒá to wydarzenie?')) {
                    appData.events = appData.events.filter(e => e.id !== eventId);
                    saveData();
                    generateWeeklyCalendar();
                    loadUpcomingEvents();
                    modal.style.display = 'none';
                }
            });
        }

        function loadAdminData() {
            loadSubjectsForAdmin();
            loadStudents();
            loadCategories();
        }

        function loadSubjectsForAdmin() {
            const subjectList = document.getElementById('subject-list');
            subjectList.innerHTML = '';
            
            if (appData.subjects.length === 0) {
                subjectList.innerHTML = '<div class="class-item">Brak przedmiot√≥w</div>';
                return;
            }
            
            appData.subjects.forEach((subject, index) => {
                const subjectItem = document.createElement('div');
                subjectItem.className = 'class-item';
                
                subjectItem.innerHTML = `
                    <div><strong>${subject}</strong></div>
                    <div class="item-actions">
                        <button class="btn btn-danger small-btn delete-subject" data-index="${index}">Usu≈Ñ</button>
                    </div>
                `;
                
                subjectList.appendChild(subjectItem);
            });
            
            document.querySelectorAll('.delete-subject').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteSubject(index);
                });
            });
        }

        function loadStudents() {
            const studentList = document.getElementById('student-list');
            studentList.innerHTML = '';
            
            if (appData.students.length === 0) {
                studentList.innerHTML = '<div class="student-item">Brak uczni√≥w</div>';
                return;
            }
            
            appData.students.forEach((student, index) => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                
                studentItem.innerHTML = `
                    <div>${student}</div>
                    <div class="item-actions">
                        <button class="btn btn-danger small-btn delete-student" data-index="${index}">Usu≈Ñ</button>
                    </div>
                `;
                
                studentList.appendChild(studentItem);
            });
            
            document.querySelectorAll('.delete-student').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteStudent(index);
                });
            });
        }

        function loadCategories() {
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = '';
            
            if (appData.categories.length === 0) {
                categoryList.innerHTML = '<div class="category-item">Brak kategorii</div>';
                return;
            }
            
            appData.categories.forEach((category, index) => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                
                categoryItem.innerHTML = `
                    <div>
                        <strong>${category.name}</strong>
                        <div style="display: inline-block; width: 20px; height: 20px; background: ${category.color}; margin-left: 10px; border: 1px solid #ddd;"></div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger small-btn delete-category" data-index="${index}">Usu≈Ñ</button>
                    </div>
                `;
                
                categoryList.appendChild(categoryItem);
            });
            
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteCategory(index);
                });
            });
        }

        function addSubject() {
            const name = document.getElementById('new-subject-name').value;
            
            if (!name) {
                alert('Proszƒô wpisaƒá nazwƒô przedmiotu');
                return;
            }
            
            if (appData.subjects.includes(name)) {
                alert('Przedmiot o tej nazwie ju≈º istnieje');
                return;
            }
            
            appData.subjects.push(name);
            saveData();
            loadSubjectsForAdmin();
            loadSubjects();
            document.getElementById('new-subject-name').value = '';
        }

        function addStudents() {
            const namesText = document.getElementById('student-names').value;
            
            if (!namesText) {
                alert('Wpisz listƒô uczni√≥w');
                return;
            }
            
            const names = namesText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            if (names.length === 0) {
                alert('Nie znaleziono poprawnych nazw uczni√≥w');
                return;
            }
            
            let addedCount = 0;
            names.forEach(name => {
                if (!appData.students.includes(name)) {
                    appData.students.push(name);
                    addedCount++;
                }
            });
            
            saveData();
            loadStudents();
            document.getElementById('student-names').value = '';
            alert(`Dodano ${addedCount} uczni√≥w`);
        }

        function addCategory() {
            const name = document.getElementById('new-category-name').value;
            const color = document.getElementById('category-color').value;
            
            if (!name) {
                alert('Proszƒô wpisaƒá nazwƒô kategorii');
                return;
            }
            
            if (appData.categories.some(c => c.name === name)) {
                alert('Kategoria o tej nazwie ju≈º istnieje');
                return;
            }
            
            appData.categories.push({ name: name, color: color });
            saveData();
            loadCategories();
            loadSubjects();
            document.getElementById('new-category-name').value = '';
        }

        function deleteSubject(index) {
            const subject = appData.subjects[index];
            
            if (confirm(`Czy na pewno chcesz usunƒÖƒá przedmiot ${subject}?`)) {
                appData.subjects.splice(index, 1);
                delete appData.grades[subject];
                delete appData.material[subject];
                saveData();
                loadSubjectsForAdmin();
                loadSubjects();
            }
        }

        function deleteStudent(index) {
            const student = appData.students[index];
            
            if (confirm(`Czy na pewno chcesz usunƒÖƒá ucznia ${student}?`)) {
                appData.students.splice(index, 1);
                
                Object.keys(appData.grades).forEach(subject => {
                    delete appData.grades[subject][student];
                });
                
                saveData();
                loadStudents();
            }
        }

        function deleteCategory(index) {
            const category = appData.categories[index];
            
            if (confirm(`Czy na pewno chcesz usunƒÖƒá kategoriƒô ${category.name}?`)) {
                appData.categories.splice(index, 1);
                
                Object.keys(appData.grades).forEach(subject => {
                    Object.keys(appData.grades[subject]).forEach(student => {
                        ['1', '2'].forEach(semester => {
                            appData.grades[subject][student][semester] = appData.grades[subject][student][semester]
                                .filter(grade => grade && grade.category !== category.name);
                        });
                    });
                });
                
                saveData();
                loadCategories();
            }
        }

        function loadSubjects() {
            const subjectSelects = ['material-subject', 'grade-subject', 'schedule-subject', 'event-subject', 'substitution-subject'];
            
            subjectSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">-- Wybierz przedmiot --</option>';
                    select.innerHTML += appData.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
                }
            });
            
            const gradeCategorySelect = document.getElementById('grade-category');
            if (gradeCategorySelect) {
                gradeCategorySelect.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                gradeCategorySelect.innerHTML += appData.categories.map(c => 
                    `<option value="${c.name}">${c.name}</option>`
                ).join('');
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateString) {
            const [year, month, day] = dateString.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('pl-PL');
        }
// ZASTƒÑP CA≈ÅƒÑ FUNKCJƒò loadResults() NASTƒòPUJƒÑCYM KODEM:

function loadResults() {
    console.log('≈Åadowanie wynik√≥w...');
    console.log('Liczba uczni√≥w:', appData.students.length); // Debug
    
    const resultsTableHead = document.getElementById('results-table-head');
    const resultsTableBody = document.getElementById('results-table-body');
    const viewMode = document.getElementById('results-semester').value;
    
    // Sprawd≈∫ czy sƒÖ uczniowie
    if (!appData.students || appData.students.length === 0) {
        resultsTableBody.innerHTML = '<tr><td colspan="10">Brak uczni√≥w w systemie</td></tr>';
        return;
    }
    
    // Tworzenie nag≈Ç√≥wk√≥w tabeli
    let headerHTML = '<tr><th rowspan="2">Lp.</th><th rowspan="2">Ucze≈Ñ</th>';
    
    // Dodaj kolumny dla ka≈ºdego przedmiotu
    appData.subjects.forEach(subject => {
        headerHTML += `<th colspan="${viewMode === 'all' ? '3' : '1'}">${subject}</th>`;
    });
    
    // Dodaj kolumny podsumowujƒÖce
    headerHTML += '<th rowspan="2">≈örednia<br>I sem.</th>';
    headerHTML += '<th rowspan="2">≈örednia<br>II sem.</th>';
    headerHTML += '<th rowspan="2">≈örednia<br>Roczna</th>';
    headerHTML += '<th rowspan="2">≈örednia<br>Og√≥lna I</th>';
    headerHTML += '<th rowspan="2">≈örednia<br>Og√≥lna II</th>';
    headerHTML += '<th rowspan="2">≈örednia<br>Og√≥lna Roczna</th>';
    headerHTML += '</tr><tr>';
    
    // Drugi wiersz nag≈Ç√≥wk√≥w - dla semestr√≥w w przedmiotach
    appData.subjects.forEach(subject => {
        if (viewMode === 'all') {
            headerHTML += '<th>I</th><th>II</th><th>R</th>';
        } else {
            headerHTML += `<th>${viewMode === '1' ? 'I' : 'II'}</th>`;
        }
    });
    
    headerHTML += '</tr>';
    resultsTableHead.innerHTML = headerHTML;
    
    // Czyszczenie tablicy
    resultsTableBody.innerHTML = '';
    
    // Tablice na ≈õrednie ca≈Çej klasy
    let allStudentsSem1Averages = [];
    let allStudentsSem2Averages = [];
    let allStudentsYearAverages = [];
    
    // Dla ka≈ºdego ucznia
    appData.students.forEach((student, index) => {
        console.log('Przetwarzam ucznia:', student); // Debug
        
        const row = document.createElement('tr');
        let rowHTML = `<td>${index + 1}</td><td class="student-name">${student}</td>`;
        
        let studentSem1SubjectAverages = [];
        let studentSem2SubjectAverages = [];
        
        // Dla ka≈ºdego przedmiotu
        appData.subjects.forEach(subject => {
            const subjectGrades = appData.grades[subject]?.[student] || { '1': [], '2': [] };
            
            // Konwertuj obiekt na tablicƒô je≈õli trzeba (jak w funkcji loadGrades)
            let sem1Grades = subjectGrades['1'] || [];
            let sem2Grades = subjectGrades['2'] || [];
            
            if (!Array.isArray(sem1Grades)) {
                const gradesArray = new Array(20).fill(null);
                Object.keys(sem1Grades).forEach(key => {
                    gradesArray[parseInt(key)] = sem1Grades[key];
                });
                sem1Grades = gradesArray.filter(g => g !== null);
            }
            
            if (!Array.isArray(sem2Grades)) {
                const gradesArray = new Array(20).fill(null);
                Object.keys(sem2Grades).forEach(key => {
                    gradesArray[parseInt(key)] = sem2Grades[key];
                });
                sem2Grades = gradesArray.filter(g => g !== null);
            }
            
            // Oblicz ≈õrednie dla przedmiotu
            const sem1Avg = calculateSemesterAverage(sem1Grades);
            const sem2Avg = calculateSemesterAverage(sem2Grades);
            const yearAvg = calculateYearAverage(sem1Grades, sem2Grades);
            
            // Zbierz dane do ≈õredniej z przedmiot√≥w
            if (sem1Avg !== '-' && !isNaN(parseFloat(sem1Avg))) {
                studentSem1SubjectAverages.push(parseFloat(sem1Avg));
            }
            if (sem2Avg !== '-' && !isNaN(parseFloat(sem2Avg))) {
                studentSem2SubjectAverages.push(parseFloat(sem2Avg));
            }
            
            // Wy≈õwietl w tabeli
            if (viewMode === 'all') {
                rowHTML += `<td class="grade-avg">${sem1Avg}</td>`;
                rowHTML += `<td class="grade-avg">${sem2Avg}</td>`;
                rowHTML += `<td class="grade-avg year-avg">${yearAvg}</td>`;
            } else if (viewMode === '1') {
                rowHTML += `<td class="grade-avg">${sem1Avg}</td>`;
            } else {
                rowHTML += `<td class="grade-avg">${sem2Avg}</td>`;
            }
        });
        
        // ≈örednia z przedmiot√≥w dla ucznia (I semestr)
        const avgFromSubjectsSem1 = studentSem1SubjectAverages.length > 0 
            ? (studentSem1SubjectAverages.reduce((a, b) => a + b, 0) / studentSem1SubjectAverages.length).toFixed(2) 
            : '-';
        
        // ≈örednia z przedmiot√≥w dla ucznia (II semestr)
        const avgFromSubjectsSem2 = studentSem2SubjectAverages.length > 0 
            ? (studentSem2SubjectAverages.reduce((a, b) => a + b, 0) / studentSem2SubjectAverages.length).toFixed(2) 
            : '-';
        
        // ≈örednia roczna z przedmiot√≥w
        let avgFromSubjectsYear = '-';
        if (avgFromSubjectsSem1 !== '-' && avgFromSubjectsSem2 !== '-') {
            avgFromSubjectsYear = ((parseFloat(avgFromSubjectsSem1) + parseFloat(avgFromSubjectsSem2)) / 2).toFixed(2);
        } else if (avgFromSubjectsSem1 !== '-') {
            avgFromSubjectsYear = avgFromSubjectsSem1;
        } else if (avgFromSubjectsSem2 !== '-') {
            avgFromSubjectsYear = avgFromSubjectsSem2;
        }
        
        // Dodaj do statystyk ca≈Çej klasy
        if (avgFromSubjectsSem1 !== '-') {
            allStudentsSem1Averages.push(parseFloat(avgFromSubjectsSem1));
        }
        if (avgFromSubjectsSem2 !== '-') {
            allStudentsSem2Averages.push(parseFloat(avgFromSubjectsSem2));
        }
        if (avgFromSubjectsYear !== '-') {
            allStudentsYearAverages.push(parseFloat(avgFromSubjectsYear));
        }
        
        // ≈örednie og√≥lne (ze wszystkich ocen)
        const overallSem1 = calculateOverallSemesterAverage(student, '1');
        const overallSem2 = calculateOverallSemesterAverage(student, '2');
        const overallYear = calculateOverallYearAverage(student);
        
        // Kolumny podsumowujƒÖce
        rowHTML += `<td class="summary-avg">${avgFromSubjectsSem1}</td>`;
        rowHTML += `<td class="summary-avg">${avgFromSubjectsSem2}</td>`;
        rowHTML += `<td class="summary-avg">${avgFromSubjectsYear}</td>`;
        rowHTML += `<td class="overall-avg">${overallSem1}</td>`;
        rowHTML += `<td class="overall-avg">${overallSem2}</td>`;
        rowHTML += `<td class="overall-avg final-avg">${overallYear}</td>`;
        
        row.innerHTML = rowHTML;
        
        // Kolorowanie na podstawie ≈õredniej
        if (overallYear !== '-') {
            const avg = parseFloat(overallYear);
            if (avg >= 4.75) row.classList.add('excellent');
            else if (avg >= 4.0) row.classList.add('good');
            else if (avg >= 3.0) row.classList.add('average');
            else if (avg >= 2.0) row.classList.add('poor');
            else row.classList.add('fail');
        }
        
        resultsTableBody.appendChild(row);
    });
    
    // Oblicz i wy≈õwietl ≈õrednie ca≈Çej klasy
    console.log('≈örednie I sem wszystkich uczni√≥w:', allStudentsSem1Averages); // Debug
    console.log('≈örednie II sem wszystkich uczni√≥w:', allStudentsSem2Averages); // Debug
    
    const classAvgSem1 = allStudentsSem1Averages.length > 0 
        ? (allStudentsSem1Averages.reduce((a, b) => a + b, 0) / allStudentsSem1Averages.length).toFixed(2) 
        : '-';
    
    const classAvgSem2 = allStudentsSem2Averages.length > 0 
        ? (allStudentsSem2Averages.reduce((a, b) => a + b, 0) / allStudentsSem2Averages.length).toFixed(2) 
        : '-';
    
    const classAvgYear = allStudentsYearAverages.length > 0 
        ? (allStudentsYearAverages.reduce((a, b) => a + b, 0) / allStudentsYearAverages.length).toFixed(2) 
        : '-';
    
    // Aktualizuj elementy DOM
    const sem1Element = document.getElementById('class-avg-sem1');
    const sem2Element = document.getElementById('class-avg-sem2');
    const yearElement = document.getElementById('class-avg-year');
    
    if (sem1Element) sem1Element.textContent = classAvgSem1;
    if (sem2Element) sem2Element.textContent = classAvgSem2;
    if (yearElement) yearElement.textContent = classAvgYear;
    
    console.log('≈örednie klasy:', { classAvgSem1, classAvgSem2, classAvgYear }); // Debug
}

// ZASTƒÑP TE FUNKCJE NASTƒòPUJƒÑCYMI WERSJAMI:

function calculateOverallSemesterAverage(student, semester) {
    let allGrades = [];
    
    appData.subjects.forEach(subject => {
        let subjectGrades = appData.grades[subject]?.[student]?.[semester] || [];
        
        // WA≈ªNE: Konwertuj obiekt na tablicƒô je≈õli to konieczne
        if (!Array.isArray(subjectGrades)) {
            const gradesArray = [];
            Object.keys(subjectGrades).forEach(key => {
                if (subjectGrades[key]) {
                    gradesArray.push(subjectGrades[key]);
                }
            });
            subjectGrades = gradesArray;
        }
        
        const validGrades = subjectGrades.filter(g => g && g.grade && GRADE_VALUES[g.grade] !== null);
        allGrades = allGrades.concat(validGrades);
    });
    
    if (allGrades.length === 0) return '-';
    
    const sum = allGrades.reduce((total, grade) => {
        return total + GRADE_VALUES[grade.grade];
    }, 0);
    
    return (sum / allGrades.length).toFixed(2);
}

function calculateOverallYearAverage(student) {
    let allGradesSem1 = [];
    let allGradesSem2 = [];
    
    appData.subjects.forEach(subject => {
        // Semestr 1
        let sem1Grades = appData.grades[subject]?.[student]?.['1'] || [];
        if (!Array.isArray(sem1Grades)) {
            const gradesArray = [];
            Object.keys(sem1Grades).forEach(key => {
                if (sem1Grades[key]) {
                    gradesArray.push(sem1Grades[key]);
                }
            });
            sem1Grades = gradesArray;
        }
        const validGrades1 = sem1Grades.filter(g => g && g.grade && GRADE_VALUES[g.grade] !== null);
        allGradesSem1 = allGradesSem1.concat(validGrades1);
        
        // Semestr 2
        let sem2Grades = appData.grades[subject]?.[student]?.['2'] || [];
        if (!Array.isArray(sem2Grades)) {
            const gradesArray = [];
            Object.keys(sem2Grades).forEach(key => {
                if (sem2Grades[key]) {
                    gradesArray.push(sem2Grades[key]);
                }
            });
            sem2Grades = gradesArray;
        }
        const validGrades2 = sem2Grades.filter(g => g && g.grade && GRADE_VALUES[g.grade] !== null);
        allGradesSem2 = allGradesSem2.concat(validGrades2);
    });
    
    const sem1 = allGradesSem1.length > 0
        ? allGradesSem1.reduce((total, grade) => total + GRADE_VALUES[grade.grade], 0) / allGradesSem1.length
        : null;
    
    const sem2 = allGradesSem2.length > 0
        ? allGradesSem2.reduce((total, grade) => total + GRADE_VALUES[grade.grade], 0) / allGradesSem2.length
        : null;
    
    if (sem1 === null && sem2 === null) return '-';
    if (sem1 === null) return sem2.toFixed(2);
    if (sem2 === null) return sem1.toFixed(2);
    
    return ((sem1 + sem2) / 2).toFixed(2);
}

function calculateSemesterAverage(semesterGrades) {
    // Zabezpieczenie - konwersja obiektu na tablicƒô
    if (!Array.isArray(semesterGrades)) {
        if (semesterGrades && typeof semesterGrades === 'object') {
            const gradesArray = [];
            Object.keys(semesterGrades).forEach(key => {
                if (semesterGrades[key]) {
                    gradesArray.push(semesterGrades[key]);
                }
            });
            semesterGrades = gradesArray;
        } else {
            semesterGrades = [];
        }
    }
    
    const validGrades = semesterGrades.filter(g => g && g.grade && GRADE_VALUES[g.grade] !== null);
    
    if (validGrades.length === 0) return '-';
    
    const sum = validGrades.reduce((total, grade) => {
        return total + GRADE_VALUES[grade.grade];
    }, 0);
    
    return (sum / validGrades.length).toFixed(2);
}

function calculateYearAverage(sem1Grades, sem2Grades) {
    const avg1 = calculateSemesterAverage(sem1Grades);
    const avg2 = calculateSemesterAverage(sem2Grades);
    
    if (avg1 === '-' && avg2 === '-') return '-';
    if (avg1 === '-') return avg2;
    if (avg2 === '-') return avg1;
    
    return ((parseFloat(avg1) + parseFloat(avg2)) / 2).toFixed(2);
}

function exportResults() {
    // Funkcja eksportu do CSV
    alert('Funkcja eksportu zostanie dodana wkr√≥tce!');
}

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
